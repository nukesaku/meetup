# しんめ.rb meetup 第34回(2025/2/3)

## アジェンダ

- しんめ.rbについて
- 直近の開催予定
  - 2月3日（月）21時〜22時半
  - 2月10日（月）21時〜22時半
  - 2月17日（月）21時〜22時半

### 今日やること

- [Hotrails](https://www.hotrails.dev/) のチュートリアルに沿ってモブプロ
  - Chapter6の`Fixing our Turbo Streams security issue`の部分から

### モブプロのすゝめ

- ドライバーをやってくれた人には全力感謝！
- 確信がなくても「こうすればできそう？」な会話、Welcome
- 「分からない」はどんどん言葉に！エスパーさせちゃうとか、ここでは気にしない！
- エラーが出たらみんなで考える、解決したらわーい🙌

### 今日やったこと

#### Turbo Streams のブロードキャストとセキュリティ

- `broadcasts_to` メソッドの最初の引数に渡すラムダの値によって、どのユーザーが同じストリームを共有するか決まる。
- 同じ値の配列 を返せばブロードキャストを共有し、異なる値の配列 を返せば共有しない。
- `signed-stream-name` が異なるユーザーはブロードキャストを受信できない ことを確認するため、ブラウザでテストを行った。

#### フラッシュメッセージの実装（Turbo 無効時）

- まず Turbo を無効にした状態でフラッシュメッセージを実装する。
- フラッシュメッセージを表示するための パーシャル を作成。
- `flash.now[:notice]` を使用することで、リダイレクトなしでフラッシュメッセージを即座に表示できる。
- フラッシュメッセージが `opacity: 0` になっても DOM に残るため、Stimulus コントローラーを使って完全に削除 する。
- Stimulus の`RemovalsController` を作成し、アニメーション終了時に DOM からメッセージを削除するように設定。

#### Turbo を有効にしてもフラッシュメッセージを正しく動作させる
- Turbo Stream ではリダイレクトしないため、`flash.now[:notice]` を使う必要がある。
  - 通常の Turbo Stream レスポンスにはフラッシュメッセージを表示する指示が含まれていないため、Turbo Stream に追加の指示を与える必要がある。
- `prepend` を使うことで、新しいフラッシュメッセージを既存のリストに追加できる。
- `id="flash"` の DOM ノードが必要なため、アプリケーションのレイアウトに追加する。
- ブラウザで素早く 2 つの引用（quote）を作成し、フラッシュメッセージが積み重なって表示され、アニメーション後に削除されることを確認。

### 参考資料

- [Turbo Reference](https://turbo.hotwired.dev/reference/drive)

